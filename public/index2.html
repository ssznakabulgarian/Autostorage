<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>QR Code Scanner</title>
    <!--<link rel="preload" as="script" href="assets/js/decoder.js">-->
  </head>
  <body>
	<video id="vid" autoplay></video>
	<canvas id="can" width="600" height="400" style="display: none;"></canvas>

    <script type="text/javascript">
		var ctx = can.getContext('2d');
		var webcam = vid;
		
		function startCapture(constraints) {
			navigator.mediaDevices
			  .getUserMedia(constraints)
			  .then(function(stream) {
				webcam.srcObject = stream;
				webcam.setAttribute('playsinline', true);
				webcam.setAttribute('controls', true);
				setTimeout(() => {
				  document.querySelector('video').removeAttribute('controls');
				});
			  })
			  .catch(function(err) {
				console.log('Error occurred ', err);
			  });
		}
		
		navigator.mediaDevices
		  .enumerateDevices()
		  .then(function(devices) {
			var device = devices.filter(function(device) {
			  var deviceLabel = device.label.split(',')[1];
			  if (device.kind == 'videoinput') {
				return device;
			  }
			});
			var constraints;
			if (device.length > 1) {
			  constraints = {
				video: {
				  mandatory: {
					sourceId: device[1].deviceId ? device[1].deviceId : null
				  }
				},
				audio: false
			  };

			  if (window.iOS) {
				constraints.video.facingMode = 'environment';
			  }
			  startCapture(constraints);
			} else if (device.length) {
			  constraints = {
				video: {
				  mandatory: {
					sourceId: device[0].deviceId ? device[0].deviceId : null
				  }
				},
				audio: false
			  };

			  if (window.iOS) {
				constraints.video.facingMode = 'environment';
			  }

			  startCapture(constraints);
			} else {
			  startCapture({ video: true });
			}
		  });
		  
			var decoder = new Worker('assets/js/decoder.js');
			decoder.onmessage = function onDecoderMessage(event) {
				if (event.data.length > 0) {
				  var qrid = event.data[0][2];
				  console.log(qrid);
				}
				setTimeout(decodeFrame, 0);
			}		  
			
		  function decodeFrame() {

			try {
			  ctx.drawImage(webcam, 0, 0, can.width, can.height);
			  var imgData = ctx.getImageData(0, 0, can.width, can.height);

			  if (imgData.data) {
				decoder.postMessage(imgData);
			  }
			} catch (e) {
			  // Try-Catch to circumvent Firefox Bug #879717
			  if (e.name == 'NS_ERROR_NOT_AVAILABLE') setTimeout(decodeFrame, 0);
			}
		  }
		  decodeFrame();

    </script>
  </body>
</html>
